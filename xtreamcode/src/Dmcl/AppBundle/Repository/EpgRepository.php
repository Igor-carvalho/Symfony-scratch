<?php

namespace Dmcl\AppBundle\Repository;

use Dmcl\AppBundle\Entity\Channel;
use Dmcl\AppBundle\Entity\Epg;
use Dmcl\AppBundle\Entity\EpgChannels;
use Doctrine\ORM\EntityRepository;

/**
 * EpgRepository
 *
 * This class was generated by the Doctrine ORM. Add your own custom
 * repository methods below.
 */
class EpgRepository extends EntityRepository
{
    /**
     * Remove the Epg in cascade. This function fix the php timeout issue.
     *
     * @param integer $id Epg id.
     */
    public function remove($id) {
        $channelsId = $this->createQueryBuilder("qb")
            ->select('ch.id')
            ->from("AppBundle:EpgChannels", "ch")
            ->where("ch.epg = :id")
            ->setParameter("id", $id)
            ->getQuery()
            ->getArrayResult();

        $query = $this->createQueryBuilder("qb")->delete("AppBundle:Programme", "p");
        foreach ($channelsId as $channelId) {
            $query->orWhere("p.channel = " . $channelId['id']);
        }
        $query->getQuery()->execute();

        $query = $this->createQueryBuilder('qb')
            ->delete("AppBundle:EpgChannels", "ch")
            ->where("ch.epg = " . $id);
        $query->getQuery()->execute();

        $query = $this->createQueryBuilder('qb')
            ->delete("AppBundle:Epg", "e")
            ->where("e.id = " . $id);
        $query->getQuery()->execute();
    }

}
