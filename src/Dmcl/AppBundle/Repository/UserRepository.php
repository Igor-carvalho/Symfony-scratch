<?php

namespace Dmcl\AppBundle\Repository;

use Dmcl\AppBundle\Entity\User;
use Doctrine\ORM\EntityRepository;

/**
 * UserRepository
 *
 * This class was generated by the Doctrine ORM. Add your own custom
 * repository methods below.
 */
class UserRepository extends EntityRepository
{

    public function findResellers()
    {
        return $this->createQueryBuilder("u")
            ->where("u.enabled =true")
            ->andWhere('u.roles LIKE CONCAT(\'%\', \'ROLE_RESELLER\', \'%\')')
            ->getQuery()
            ->getResult();z
    }

    public function getTotalUsers()
    {
        return $count = $this->createQueryBuilder("c")
            ->select('COUNT(c)')
            ->getQuery()
            ->getResult();

    } 

    public function getActiveUsers()
    {
        $delay = new \DateTime();
        $delay->setTimestamp(strtotime('2 minutes ago'));

        $qb = $this->createQueryBuilder('u')
            ->where('u.lastActivityAt > :delay')
            ->setParameter('delay', $delay);

        return $qb->getQuery()->getResult();
    }

    public function hasChannel($id, $live)
    {
        return
            $this->createQueryBuilder("u")
                ->innerJoin("u.activationCodes", "ac")
                ->innerJoin("ac.channelsPackage", "cp")
                ->innerJoin("cp.channels", "c")
                ->where("u.id = :id")
                ->andWhere("c.live = :live")
                ->setParameter("id", $id())
                ->setParameter("live", $live)
                ->getQuery()
                ->getResult()
                ? true
                : false;
    }
}
