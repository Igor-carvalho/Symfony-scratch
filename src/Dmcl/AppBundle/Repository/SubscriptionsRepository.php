<?php

namespace Dmcl\AppBundle\Repository;

use Doctrine\ORM\EntityRepository;

/**
 * SubscriptionsRepository
 *
 * This class was generated by the Doctrine ORM. Add your own custom
 * repository methods below.
 */
class SubscriptionsRepository extends EntityRepository
{

    public function getTotalSalesByType($type){
        return $count = $this->createQueryBuilder("s")
            ->select('COUNT(s)')
            ->where("s.productType=:type")
            ->andWhere("s.forTest=false")
            ->setParameter("type",$type)
            ->getQuery()
            ->getResult();
    }

    public function totalForDashboard($type){
        $sales =  $this->createQueryBuilder("s")
            ->where("s.forTest=false")
            ->andWhere("s.productType=:type")
            ->setParameter("type",$type)
            ->getQuery()
            ->getResult();

        foreach ([11, 10, 9, 8, 7, 6, 5, 4, 3, 2, 1, 0] as $d) {
            $dashboardSales[(new \DateTime("now - $d months"))->format("Ym")]=0;
        }

        foreach ($sales as $sale) {
            $dashboardSales[$sale->getCreatedAt()->format("Ym")]+=1;
        }
        return $dashboardSales;

    }

}
